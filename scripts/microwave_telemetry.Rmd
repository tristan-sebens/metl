```{r}
library(tidyverse)

mt_d = here::here('data', 'Microwave Telemetry', 'X-Tag')

mt_template_d = file.path(mt_d, 'Sablefish', '148402')
```


```{r}
d = mt_template_d

mt_dc__ = 
  Decoder_MicrowaveTelemetry_XTag(d = d)

mt_dc__$decode(con)

MicrowaveTelemetry_XTag_TagMetaData()$extract(d)

mt_dm__ = mt_dc__$data_maps[[1]]

mt_dm__$input_data_field_map
```

```{r}
fs = list.files(.self$d, pattern = "\\.txt$", full.names = T)

fs %>% 
  lapply(
    function(fp) {
      read.csv(fp, sep = "\t")
    }
  )
```



```{r}
fs = list.files(.self$d, pattern = "^\\d*p\\.txt", full.names = T)

if (length(fs) > 1) {
  stop(paste0("Input File Error - Too many input files match template in directory ", .self$d))
}

mt_dat_ = 
  read.csv(
    fs,
    header = F,
    col.names = c("datetime", "pressure", "gain"),
    sep = '\t'
  )

mt_dat_ %>% 
  ggplot(aes(pressure)) + 
  geom_histogram()


pressure = read.csv(fs, sep = '\t')$Press
```

Extract data from .xls file
```{r}
mt_xt_xl_fp = list.files(.self$d, pattern = "^\\d*\\.xls", full.names = T)

press_dat_ = 
  # Read the data from the pressure data sheet in the xls file
  readxl::read_xls(
    path = mt_xt_xl_fp,
    sheet = "Press Data",
    # Calculate the range of data to include
    range = 
      paste0(
        "A3:D",
        # Read in the full, unfiltered sheet to count the number of rows of data
        nrow(
          readxl::read_xls(
            path = mt_xt_xl_fp,
            sheet = "Press Data",
            skip=1
          )
        ) + 2 # Add two rows for the header row and the title row
      ),
    col_names = 
      c(
        'datetime',
        'sensor_val',
        'gain',
        'depth'
      )
  ) %>% 
  dplyr::mutate(
    depth = units::set_units(-1 * depth, 'm')
  )


temp_dat_ = 
  # Read the data from the temperature data sheet in the xls file
  readxl::read_xls(
    path = mt_xt_xl_fp,
    sheet = "Temp Data",
    # Calculate the range of data to include
    range = 
      paste0(
        "A3:C",
        # Read in the full, unfiltered sheet to count the number of rows of data
        nrow(
          readxl::read_xls(
            path = mt_xt_xl_fp,
            sheet = "Temp Data",
            skip=1
          )
        ) + 2 # Add two rows for the header row and the title row
      ),
    col_names = 
      c(
        'datetime',
        'sensor_val',
        'temperature'
      )
  ) %>% 
  dplyr::mutate(
    temperature = units::set_units(temperature, 'Â°C')
  )


dat_ = 
  merge(
    dplyr::select(press_dat_, -sensor_val, -gain),
    dplyr::select(temp_dat_, -sensor_val),
    all.x = T,
    all.y = T
  )
```

Identify tag_id from directory
```{r}
list.files(path = mt_template_d, pattern = "^\\d*\\.xls") %>% 
  stringr::str_extract(pattern = "^(\\d*)\\.xls", group=1)
```























